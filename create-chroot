#!/usr/bin/env python
# File: create-chroot
# Author: Nicholas Girga
# Purpose: Create a filesystem to be used by chroot or similar utilities.


# Imports
import depchecker.depchecker as depchecker
import os, sys, subprocess


# The packages to install in a chroot by default.
# Represented by a string separated by spaces.
# For example: "linux bash coreutils"
DEFAULT_PACKAGES = "linux bash coreutils sed vi vim perl pacman sudo curl"


# The path to this chroot.
path = ""

# The packages to install in this chroot.
# Represented by a string separated by spaces.
# For example: "linux bash coreutils"
packages = ""

# If extra information should be printed.
verbose = False

# If files and directories at the path should be deleted.
force_delete = False


# Prints help text.
def print_help():
    print("\nUsage: `create-chroot [options...] [path]`")
    print("\nOptions [options...]:")
    print("  -h, --help\t\tPrints help text.")
    print("  -v, --verbose\t\tEnables verbose mode.")
    print("  -F\t\t\tOverwrites files and directories at [path].")
    print("  -p=[packages]\t\tInstalls [packages] to the chroot.")
    print("  --packages=[packages]\t(Does the same as `-p`).")
    print("\nIf [path] is left empty, `$PWD/arch-fs` will be used as the path.")


# Check for script dependencies.
depchecker.check_dependencies({
    "mkarchroot": { depchecker.SystemInfo.ARCH_LINUX: "devtools" } # check for `mkarchroot`
}, verbose)


# Check launch options.
args = sys.argv[1:]
for arg in args:
    if len(arg) > 0:
        if arg[0] == '-':
            if len(arg) > 1:
                if arg[1] == '-':
                    # is double dash (word) option (e.g. `--help`)
                    if arg == "--help":
                        print_help() # help
                        sys.exit(0)
                    elif arg == "--verbose":
                        print("WARNING!: Verbose mode is enabled! Extra information will be given.")
                        verbose = True # enable verbose mode
                    elif arg == "--force":
                        print("WARNING!: Force deletion is enabled! Files and directories at the filesystem's path will be overwritten!")
                        force_delete = True # enable force deletion
                    else:
                        print(  "ERROR!: Invalid option (" + arg + ")!\n" +
                                "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                        sys.exit(1) # invalid option; exit with code 1
                else:
                    # is single dash/char option (e.g. `-v`)
                    for char in arg[1:]:
                        if char == 'h':
                            print_help() # help
                            sys.exit(0)
                        if char == 'v':
                            print("WARNING!: Verbose mode is enabled! Extra information will be given.")
                            verbose = True # enable verbose mode
                        else:
                            print(  "ERROR!: Invalid option (-" + char + ")!\n" +
                                    "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                            sys.exit(1) # invalid option; exit with code 1
            else:
                print(  "ERROR!: Invalid syntax (" + arg + ")!\n" +
                        "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                sys.exit(2) # invalid syntax (-); exit with code 2
    else:
        print("ERROR!: Option has invalid character length (" + arg + ")!", ' ', '\n', sys.stderr)
        sys.exit(3) # invalid launch option character length; exit with code 3


# Set default path if needed.
if path == "":
    new_path = os.getcwd() + "/arch-fs"
    if verbose:
        print("WARNING!: No path specified! Using default path (" + new_path + ")!")
    path = new_path


# Set default packages if needed.
if packages == "":
    if verbose:
        print("WARNING!: No packages specified! Using default packages!")
        print("Package list: [ " + ", ".join(DEFAULT_PACKAGES.split(' ')) + " ]")
    packages = DEFAULT_PACKAGES


# Do not allow creation if filesystem directory already exists.
is_file = os.path.isfile(path)
is_dir = os.path.isdir(path)
if is_file or is_dir:
    if not force_delete:
        print(  "ERROR!: " + ("File" if is_file else "Directory") + " exists at path (" + path + ")!\n" +
                "Use the `--force` option to delete it before creation.")
        sys.exit(4) # file or directory exists at path; exit with code 4

    print("WARNING!: Overwriting " + ("file" if is_file else "directory") + " at path!")

    if verbose:
        print("Deleting " + ("file" if is_file else "directory") + " at path (" + path + ")...")
    
    try:
        subprocess.run(["./delete-chroot", path], capture_output = not verbose) # overwrite
    except Exception as e:
        print(str(e) + "\nERROR!: Something happened while trying to delete the Arch Linux chroot filesystem!")
        sys.exit(5) # failed to delete chroot filesystem; exit with code 5

    if verbose:
        print("Finished deleting " + ("file" if is_file else "directory") + " at path (" + path + ")!")


# get package list
package_list = packages.split(' ')


# use mkarchroot to create a root filesystem
print("Creating new Arch Linux root filesystem...")
output = subprocess.run(["mkarchroot", path] + package_list, capture_output = not verbose) # create new arch root filesystem at ./arch-fs
if not output.returncode == 0:
    print(  "WARNING!: Returned with non-zero error code (" + str(output.returncode) + ")!\n" +
            "If problems occur, try recreating the filesystem with the `-v` option for more information.")
print("Finished creating new Arch Linux root filesystem!\n\nDone!\n")
