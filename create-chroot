#!/usr/bin/env python
# File: create-chroot
# Author: Nicholas Girga
# Purpose: Create a filesystem to be used by chroot or similar utilities.


# Imports
import depchecker.depchecker as depchecker
import os, sys, subprocess


# The packages to install in a chroot by default.
# Represented by a string separated by spaces.
# For example: "linux bash coreutils"
DEFAULT_PACKAGES = "linux bash coreutils vi vim perl pacman sudo curl"


# The path to this chroot.
path = ""

# The packages to install in this chroot.
# Represented by a string separated by spaces.
# For example: "linux bash coreutils"
packages = ""

# If extra information should be printed.
verbose = False


# Prints help text.
def print_help():
    print("\nUsage: `create-chroot [options...] [path]`")
    print("\nOptions [options...]:")
    print("  -h, --help\t\tPrints help text.")
    print("  -v, --verbose\t\tEnables verbose mode.")
    print("  -F\t\t\tOverwrites files and directories at [path].")
    print("  -p=[packages]\t\tInstalls [packages] to the chroot.")
    print("  --packages=[packages]\t(Does the same as `-p`).")
    print("\nIf [path] is left empty, `$PWD/arch-fs` will be used as the path.")


# Check for script dependencies.
depchecker.check_dependencies({
    "mkarchroot": { depchecker.SystemInfo.ARCH_LINUX: "devtools" } # check for `mkarchroot`
}, verbose)


# Check launch options.
args = sys.argv[1:]
for arg in args:
    if len(arg) > 0:
        if arg[0] == '-':
            if len(arg) > 1:
                if arg[1] == '-':
                    # is double dash (word) option (e.g. `--help`)
                    if arg == "--help":
                        print_help() # help
                        sys.exit(0)
                    elif arg == "--verbose":
                        print("WARNING!: Verbose mode is enabled! Extra information will be given.")
                        verbose = True # enable verbose mode
                    else:
                        print(  "ERROR!: Invalid option (" + arg + ")!\n" +
                                "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                        sys.exit(1) # invalid option; exit with code 1
                else:
                    # is single dash/char option (e.g. `-v`)
                    for char in arg[1:]:
                        if char == 'h':
                            print_help() # help
                            sys.exit(0)
                        if char == 'v':
                            print("WARNING!: Verbose mode is enabled! Extra information will be given.")
                            verbose = True # enable verbose mode
                        else:
                            print(  "ERROR!: Invalid option (-" + char + ")!\n" +
                                    "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                            sys.exit(1) # invalid option; exit with code 1
            else:
                print(  "ERROR!: Invalid syntax (" + arg + ")!\n" +
                        "Use `create-chroot --help` for more information.", ' ', '\n', sys.stderr)
                sys.exit(2) # invalid syntax (-); exit with code 2
    else:
        print("ERROR!: Option has invalid character length (" + arg + ")!", ' ', '\n', sys.stderr)
        sys.exit(3) # invalid launch option character length; exit with code 3


# Set default path if needed.
if path == "":
    new_path = os.getcwd() + "/arch-fs"
    if True:
        print("WARNING!: No path specified! Using default path (" + new_path + ")!")
    path = new_path


# Set default packages if needed.
if packages == "":
    if True:
        print("WARNING!: No packages specified! Using default packages!")
        print("Package list: [ " + ", ".join(DEFAULT_PACKAGES.split(' ')) + " ]")
    packages = DEFAULT_PACKAGES


# Do not allow creation if filesystem directory already exists.
is_file = os.path.isfile(path)
is_dir = os.path.isdir(path)
if is_file or is_dir:
    print("ERROR!: The root filesystem for the Arch Linux chroot already exists.")
    print("Use \`./start-chroot\` to start the chroot or \`./delete-chroot\` to delete it.")
    sys.exit()


# get package list
package_list = packages.split(' ')


# use mkarchroot to create a root filesystem
print("Creating new Arch Linux root filesystem...")
subprocess.run(["mkarchroot", path] + package_list) # create new arch root filesystem at ./arch-fs
print("Finished creating new Arch Linux root filesystem!\n\nDone!\n")
